---
title: "Untitled"
output: html_document
---

```{r}

if(!require(dplyr)){install.packages("base")}
if(!require(dplyr)){install.packages("rpart")}
if(!require(dplyr)){install.packages("WeightedROC")}
if(!require(dplyr)){install.packages("rpart.plot")}
#library(dplyr)
#library(ggplot2)
library(WeightedROC)
library(rpart)
library(rpart.plot)
library(base)

```


```{r setup, include=FALSE}
#import data
high <- read.csv("../data/highDim_dataset.csv")
low <- read.csv("../data/lowDim_dataset.csv")

low$A <- as.factor(low$A)
high$A <- as.factor(high$A)
X_high <- high %>% select(-Y, -A) %>% as.matrix
A_high <- high %>% select(A) %>% as.matrix
X_low <- low %>% select(-Y, -A) %>% as.matrix
A_low <- low %>% select(A) %>% as.matrix

start_time <- Sys.time()
```



#Propensity Score Estimation


```{r}
# create tree model for high dimensional data with best cp parameter
Reg_tree_high <- rpart(A ~ . - Y, method = "class", data = high)

# calculate propensity scores
propensity_score_high <- predict(Reg_tree_high, newdata = high[, -2], type = "prob")[, 2]


```

```{r}
# create tree model for low dimensional data with best cp parameter
Reg_tree_low <- rpart(A ~ . - Y, method = "class", data = low)

# calculate propensity scores
propensity_score_low <- predict(Reg_tree_low, newdata = low[, -2], type = "prob")[, 2]

```



#ATE Estimation


# Finding weights
```{r}
weight_low <- cbind(as.numeric(A_low), propensity_score_low) %>% 
  as_tibble %>%
  mutate(weights = (V1/propensity_score_low + (1-V1)/(1-propensity_score_low))) %>%
  select(weights)
```

```{r}
weight_high <- cbind(as.numeric(A_high), propensity_score_high) %>%
  as_tibble %>%
  mutate(weights = (V1/propensity_score_high) + (1-V1)/(1-propensity_score_high)) %>%
  select(weights)
```

# Linear regression for selecting covarites
```{r}
filter_low <- summary(lm(Y~., data = low))$coef[,4][3:24]<0.05
Z_low <- cbind(A_low, X_low[,filter_low])
Z_low <- Z_low %>% apply(2, as.numeric)
```

```{r}
# Final Regression for ATE
Y_low <- low$Y
weighted_low <- lm(Y_low ~ Z_low, weights = as.numeric(unlist(weight_low)))
ATE_low <- coef(weighted_low)[2]
end_time <- Sys.time()
running_time_low = end_time - start_time
```

```{r}
set.seed(0)
start_time <- Sys.time()
weight_high <- cbind(as.numeric(A_high), propensity_score_high) %>% 
  as_tibble %>% mutate(weights= (V1/propensity_score_high) +
                         (1-V1)/(1-propensity_score_high)) %>% select(weights)
filter_high <- summary(lm(Y~., data = high))$coef[,4][3:ncol(X_high)]<0.05
Z_high <- cbind(A_high, X_high[,filter_high])
```


```{r}
Z_high <- Z_high %>% apply(2, as.numeric)
Y_high <- high$Y
weighted_high <- lm(Y_high ~ Z_high, weights = as.numeric(unlist(weight_high)))
ATE_high <- coef(weighted_high)[2]
end_time <- Sys.time()
running_time_high = end_time - start_time
matrix(c(ATE_high,ATE_low,running_time_high,
         running_time_low),nrow = 2,byrow = TRUE,
       dimnames = list(c("ATE","running_time (secs)"), c("highDim","lowDim")))


```